<html>
<head>
<title>Using Lithium to reduce bugs in Firefox</title>
</head>

<body>

<h2>Using Lithium to reduce bugs in Firefox</h2>

<p>Lithium has been used it to make reduced testcases for hundreds of crashes and assertion bugs in Firefox.  Here's how.</p>


<h3>Preparing the testcase</h3>

<p>If the testcase is pure JavaScript with no DOM interaction, use the <a href="http://developer.mozilla.org/en/docs/Introduction_to_the_JavaScript_shell">command-line JavaScript Shell</a> instead of Firefox.</p>

<p>If the testcase has to run in Firefox:</p>

<ol>

<li>Make the testcase cause Firefox to exit when finished, using goQuitApplication() in examples/mozilla/quit.js.</li>

<li>Tell Lithium what section of the testcase file it is allowed to reduce, by adding comment lines containing "DDBEGIN" and "DDEND" to the file.  This prevents Lithium from needlessly introducing syntax errors or removing the goQuitApplication() call.</li>

</ol>


<h3>Running Lithium</h3>

<p>Lithium's general syntax is:</p>

<pre>
    ./lithium.py (interestingness-test) (file-to-reduce) [extra arguments for the test]
</pre>

<p>You'll usually be able to use one of the tests that comes with Lithium:</p>

<table border="1" style="border-collapse: collapse; border-color: #bbb;">
<thead>
<tr><th>Test</th><th>Parameters</th><th>What it tests</th></tr>
</thead>
<tbody>
<tr><td>outputs.sh</td><td>app, X</td><td>(App run with the testcase) outputs X</td></tr>
<tr><td>outputs1.sh</td><td>app, X, Y</td><td>(App run with the testcase) outputs X but not Y</td></tr>
<tr><td>crashes.py</td><td>app, [timeout=300]</td><td>(App run with the testcase) crashes</td></tr>
<tr><td>hangs.py</td><td>app, [timeout=30]</td><td>(App run with the testcase) does not exit within the timeout, in seconds</td></tr>
</tbody>
</table>

<p>For example, suppose you have a large file called boom.html that triggers an assertion in debug builds of Firefox.  To make a reduced testcase, you might use something like:</p>

<pre>
    ./lithium.py ./outputs.sh boom.html fxdebug/firefox-bin "ASSERTION: index out of range"
</pre>

<p>Lithium will try to remove as many lines from boom.html as possible while still causing Firefox to print that assertion message.</p>


<h3>Tips</h3>

<h4>All operating systems</h4>

<ul>
<li>Before testing a given build of Firefox, make sure that build of Firefox is the one you ran most recently.  Otherwise, Firefox will restart in a way that makes it seem to Lithium like Firefox has exited (see <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=271613">bug 271613</a>).  This kind of restart can also cause a testcase filename to be treated as a hostname (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=396003">bug 396003</a>).</li>
<li>Before testing crashes, <a href="http://kb.mozillazine.org/Breakpad#Enabling_Breakpad">turn off Firefox's Breakpad crash reporter</a>.</li>
<li>Before testing crashes, <a href="http://kb.mozillazine.org/Browser.sessionstore.resume_from_crash">turn off session restore</a>.</li>
<li>When testing crashes, it's usually better to use outputs1.sh than crashes.py.  Lithium often gets confused by random startup crashes if you use crashes.py; it thinks an intermediate testcase crashes Firefox when the crash was just a random startup crash.</li>
<li>You might want to edit the test files to hard-code your Firefox path and/or -P profilename.</li>
</ul>

<h4>Mac</h4>

<ul>
<li>Before testing crashes in GUI apps, turn off the OS crash dialog by running CrashReporterPrefs and set it on "Server" mode.  Remember to set it back to "Developer" mode when you're done.</li>
<li>When using tests based on timed_run.py (crashes.py / hangs.py), give it "firefox-bin", not "firefox".  The "firefox" shell script runs firefox-bin in a way that prevents timed_run.py's hang protection from killing firefox-bin.</li>
<li>Since you'll be using your computer for other things while Lithium reduces the testcase, you'll probably want to work around <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=320746">bug 320746</a> (pressing the Alt key while Firefox is starting triggers the Safe Mode dialog, even if Firefox doesn't have focus) by commenting out that code in your Firefox tree.</li>
<li>If Firefox opens two windows, you're probably hitting <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=366009">bug 366009</a>.  Apply the patch there.</li>
</ul>

<h4>Windows</h4>

<ul>
<li>To turn off the crash dialog, use regedit to change the following keys in [HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AeDebug]:
<pre>
     "Auto"="1"
     "UserDebuggerHotKey"=dword:00000000
     "Debugger"=""
</pre>
   <p>Be sure to keep the previous value for Debugger around so you can set it back.</p>
</li>
</ul>

</body>
</html>
